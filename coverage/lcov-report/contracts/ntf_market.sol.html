<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\ntf_market.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> ntf_market.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>45/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">53.13% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>17/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>58/58</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: SEE LICENSE IN LICENSE
pragma solidity ^0.8.20;
&nbsp;
import "./interfaces/IERC20.sol";
import "./interfaces/IERC721.sol";
import "./interfaces/IERC721Receiver.sol";
import "./utils/SafeMath.sol";
&nbsp;
contract NFTMarket is IERC721Receiver {
    IERC20 public erc20;
    IERC721 public erc721;
&nbsp;
    bytes4 constant MAGIC_ON_ERC721_RECEIVED = 0x150b7a02;
&nbsp;
    struct Order {
        address seller;
        uint256 tokenId;
        uint256 price;
    }
&nbsp;
    Order[] public orders;
&nbsp;
    mapping(uint256 =&gt; Order) public OrderOfId;
    mapping(uint256 =&gt; uint256) public idToOrderIndex;
&nbsp;
    event Deal(address indexed seller, address indexed buyer, uint256 tokenId, uint256 price);
    event NewOrder(address indexed seller, uint256 tokenId, uint256 price);
    event CancelOrder(address indexed seller, uint256 tokenId);
    event ChangePrice(address indexed seller, uint256 tokenId, uint256 previousPrice ,uint256 price);
&nbsp;
    constructor(IERC20 _erc20, IERC721 _erc721) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(address(_erc20) != address(0), "Market: Invalid ERC20 Token");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(address(_erc721) != address(0), "Market: Invalid ERC721 Token");
        erc20 = _erc20;
        erc721 = _erc721;
    }
&nbsp;
    function buy(uint256 _tokenId, uint256 _price) external {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(isListed(_tokenId), "Market: Token ID is not listed");
&nbsp;
        address seller = OrderOfId[_tokenId].seller;
        address buyer = msg.sender;
        uint256 price = OrderOfId[_tokenId].price;
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(price == _price, "Market: Price is not ehough");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(
            erc20.transferFrom(buyer, seller, price),
            "Market: Transfer failed"
        );
        erc721.safeTransferFrom(address(this), buyer, _tokenId);
&nbsp;
        removeListing(_tokenId);
        emit Deal(buyer, seller, _tokenId, _price);
    }
&nbsp;
    function cancelOrder(uint256 _tokenId) external {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(isListed(_tokenId), "Market: Token ID is not listed");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(
            msg.sender == OrderOfId[_tokenId].seller,
            "Market: Only seller can cancel order"
        );
&nbsp;
        erc721.safeTransferFrom(address(this), msg.sender, _tokenId);
&nbsp;
        removeListing(_tokenId);
        emit CancelOrder(msg.sender, _tokenId);
    }
&nbsp;
    function changePrice(uint256 _tokenId, uint256 _price) external {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(isListed(_tokenId), "Market: Token ID is not listed");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(
            msg.sender == OrderOfId[_tokenId].seller,
            "Market: Only seller can change price"
        );
&nbsp;
        uint256 previousPrice = OrderOfId[_tokenId].price;
        OrderOfId[_tokenId].price = _price;
        Order storage order = orders[idToOrderIndex[_tokenId]];
        order.price = _price;
&nbsp;
        emit ChangePrice(msg.sender, _tokenId, previousPrice, _price);
    }
&nbsp;
    function onERC721Received(
        address _operator,
        address _seller,
        uint256 _tokenId,
        bytes calldata _data
    ) external override returns (bytes4) {
        uint256 _price = toUint256(_data, 0);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_price &gt; 0, "Market: Invalid price");
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_seller != address(0), "Market: Invalid seller");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!isListed(_tokenId), "Market: Token ID is already listed");
&nbsp;
        orders.push(Order(_seller, _tokenId, _price));
        OrderOfId[_tokenId] = Order(_seller, _tokenId, _price);
        idToOrderIndex[_tokenId] = orders.length - 1;
&nbsp;
        emit NewOrder(_seller, _tokenId, _price);
&nbsp;
        return MAGIC_ON_ERC721_RECEIVED;
    }
     
    function isListed(uint256 _tokenId) public view returns (bool) {
        return OrderOfId[_tokenId].seller != address(0);
    }
&nbsp;
    function removeListing(uint256 _tokenId) internal {
        uint256 lastOrderIndex = orders.length - 1;
        uint256 removedOrderIndex = idToOrderIndex[_tokenId];
        
        if (removedOrderIndex != lastOrderIndex) {
            Order storage lastOrder = orders[lastOrderIndex];
            orders[removedOrderIndex] = lastOrder;
            idToOrderIndex[lastOrder.tokenId] = removedOrderIndex;
        }
        orders.pop();
&nbsp;
        delete OrderOfId[_tokenId];
        delete idToOrderIndex[_tokenId];
    }
&nbsp;
    function getOrderLength() public view returns (uint256) {
        return orders.length;
    }
&nbsp;
    function getAllNFTs() external view returns (Order[] memory) {
        return orders;
    }
&nbsp;
    function getMyNFTs() external view returns (Order[] memory) {
        Order[] memory myOrders = new Order[](orders.length);
        uint256 myOrderIndex = 0;
        for (uint256 i = 0; i &lt; orders.length; i++) {
            <span class="missing-if-branch" title="else path not taken" >E</span>if (orders[i].seller == msg.sender) {
                myOrders[myOrderIndex] = orders[i];
                myOrderIndex++;
            }
        }
        return myOrders;
    }
&nbsp;
    function toUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_start + 32 &gt;= _start, "Market: toUint out of range");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_bytes.length &gt;= (_start + 32), "Market: toUint256 out of range");
        uint256 tempUint;
&nbsp;
        assembly {
            tempUint := mload(add(add(_bytes, 0x20), _start))
        }
&nbsp;
        return tempUint;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Dec 01 2023 14:14:06 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
