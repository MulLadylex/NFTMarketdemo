<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\nft_market\ntf_market.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/nft_market/</a> ntf_market.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/58</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: SEE LICENSE IN LICENSE
pragma solidity ^0.8.20;
&nbsp;
import "./interfaces/IERC20.sol";
import "./interfaces/IERC721.sol";
import "./interfaces/IERC721Receiver.sol";
import "./utils/SafeMath.sol";
&nbsp;
contract NFTMarket is IERC721Receiver {
    IERC20 public erc20;
    IERC721 public erc721;
&nbsp;
    bytes4 constant MAGIC_ON_ERC721_RECEIVED = 0x150b7a02;
&nbsp;
    struct Order {
        address seller;
        uint256 tokenId;
        uint256 price;
    }
&nbsp;
    Order[] public orders;
&nbsp;
    mapping(uint256 =&gt; Order) public OrderOfId;
    mapping(uint256 =&gt; uint256) public idToOrderIndex;
&nbsp;
    event Deal(address indexed seller, address indexed buyer, uint256 tokenId, uint256 price);
    event NewOrder(address indexed seller, uint256 tokenId, uint256 price);
    event CancelOrder(address indexed seller, uint256 tokenId);
    event ChangePrice(address indexed seller, uint256 tokenId, uint256 previousPrice ,uint256 price);
&nbsp;
<span class="fstat-no" title="function not covered" >    constructor(IERC20 _erc20, IERC721 _erc721) {</span>
<span class="cstat-no" title="statement not covered" >        require(address(_erc20) != address(0), "Market: Invalid ERC20 Token")</span>;
<span class="cstat-no" title="statement not covered" >        require(address(_erc721) != address(0), "Market: Invalid ERC721 Token")</span>;
        erc20 = _erc20;
        erc721 = _erc721;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function buy(uint256 _tokenId, uint256 _price) external {</span>
<span class="cstat-no" title="statement not covered" >        require(isListed(_tokenId), "Market: Token ID is not listed")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        address seller = OrderOfId[_tokenId].seller;</span>
<span class="cstat-no" title="statement not covered" >        address buyer = msg.sender;</span>
<span class="cstat-no" title="statement not covered" >        uint256 price = OrderOfId[_tokenId].price;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        require(price == _price, "Market: Price is not ehough")</span>;
<span class="cstat-no" title="statement not covered" >        require(</span>
            erc20.transferFrom(buyer, seller, price),
            "Market: Transfer failed"
        );
<span class="cstat-no" title="statement not covered" >        erc721.safeTransferFrom(address(this), buyer, _tokenId)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        removeListing(_tokenId)</span>;
<span class="cstat-no" title="statement not covered" >        emit Deal(buyer, seller, _tokenId, _price);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function cancelOrder(uint256 _tokenId) external {</span>
<span class="cstat-no" title="statement not covered" >        require(isListed(_tokenId), "Market: Token ID is not listed")</span>;
<span class="cstat-no" title="statement not covered" >        require(</span>
            msg.sender == OrderOfId[_tokenId].seller,
            "Market: Only seller can cancel order"
        );
&nbsp;
<span class="cstat-no" title="statement not covered" >        erc721.safeTransferFrom(address(this), msg.sender, _tokenId)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        removeListing(_tokenId)</span>;
<span class="cstat-no" title="statement not covered" >        emit CancelOrder(msg.sender, _tokenId);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function changePrice(uint256 _tokenId, uint256 _price) external {</span>
<span class="cstat-no" title="statement not covered" >        require(isListed(_tokenId), "Market: Token ID is not listed")</span>;
<span class="cstat-no" title="statement not covered" >        require(</span>
            msg.sender == OrderOfId[_tokenId].seller,
            "Market: Only seller can change price"
        );
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 previousPrice = OrderOfId[_tokenId].price;</span>
        OrderOfId[_tokenId].price = _price;
<span class="cstat-no" title="statement not covered" >        Order storage order = orders[idToOrderIndex[_tokenId]];</span>
        order.price = _price;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit ChangePrice(msg.sender, _tokenId, previousPrice, _price);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function onERC721Received(</span>
        address _operator,
        address _seller,
        uint256 _tokenId,
        bytes calldata _data
    ) external override returns (bytes4) {
<span class="cstat-no" title="statement not covered" >        uint256 _price = toUint256(_data, 0);</span>
<span class="cstat-no" title="statement not covered" >        require(_price &gt; 0, "Market: Invalid price")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        require(_seller != address(0), "Market: Invalid seller")</span>;
<span class="cstat-no" title="statement not covered" >        require(!isListed(_tokenId), "Market: Token ID is already listed")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        orders.push(Order(_seller, _price, _tokenId))</span>;
        OrderOfId[_tokenId] = Order(_seller, _price, _tokenId);
        idToOrderIndex[_tokenId] = orders.length - 1;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit NewOrder(_seller, _tokenId, _price);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        return MAGIC_ON_ERC721_RECEIVED;</span>
    }
     
<span class="fstat-no" title="function not covered" >    function isListed(uint256 _tokenId) public view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return OrderOfId[_tokenId].seller != address(0);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function removeListing(uint256 _tokenId) internal {</span>
<span class="cstat-no" title="statement not covered" >        uint256 lastOrderIndex = orders.length - 1;</span>
<span class="cstat-no" title="statement not covered" >        uint256 removedOrderIndex = idToOrderIndex[_tokenId];</span>
        
<span class="cstat-no" title="statement not covered" >        if (removedOrderIndex != lastOrderIndex) {</span>
<span class="cstat-no" title="statement not covered" >            Order storage lastOrder = orders[lastOrderIndex];</span>
            orders[removedOrderIndex] = lastOrder;
            idToOrderIndex[lastOrder.tokenId] = removedOrderIndex;
        }
<span class="cstat-no" title="statement not covered" >        orders.pop()</span>;
&nbsp;
        delete OrderOfId[_tokenId];
        delete idToOrderIndex[_tokenId];
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getOrderLength() public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return orders.length;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getAllNFTs() external view returns (Order[] memory) {</span>
<span class="cstat-no" title="statement not covered" >        return orders;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getMyNFTs() external view returns (Order[] memory) {</span>
<span class="cstat-no" title="statement not covered" >        Order[] memory myOrders = new Order[](orders.length);</span>
<span class="cstat-no" title="statement not covered" >        uint256 myOrderIndex = 0;</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; orders.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            if (orders[i].seller == msg.sender) {</span>
                myOrders[myOrderIndex] = orders[i];
                myOrderIndex++;
            }
        }
<span class="cstat-no" title="statement not covered" >        return myOrders;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function toUint256(bytes memory _bytes, uint256 _start) internal pure returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        require(_start + 32 &gt;= _start, "Market: toUint out of range")</span>;
<span class="cstat-no" title="statement not covered" >        require(_bytes.length &gt;= (_start + 32), "Market: toUint256 out of range")</span>;
<span class="cstat-no" title="statement not covered" >        uint256 tempUint;</span>
&nbsp;
        assembly {
            tempUint := mload(add(add(_bytes, 0x20), _start))
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        return tempUint;</span>
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Dec 01 2023 12:20:24 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
